<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MorTeam</title>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Exo+2:400,300,200' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="css/index.css" type="text/css">
  <link href="jbox/themes/TooltipDark.css" rel="stylesheet">
  <link href="jbox/jBox.css" rel="stylesheet">
  <script src="http://js.nicedit.com/nicEdit-latest.js" type="text/javascript"></script>
  <script type="text/javascript">
    bkLib.onDomLoaded(function() {
      new nicEditor({
          buttonList: ['bold', 'italic', 'underline', 'left', 'center', 'right', 'justify', 'removeformat', 'hr', 'upload']
      }).panelInstance('main_textarea');
    });
  </script>
  <script src="js/spin.js"></script>
  <script type="text/javascript">
      var loadingDiv = document.createElement("div");
      loadingDiv.className = "loading_circle";
      loadingDiv.id = "loading_circle";
  </script>
</head>

<body>
  <div id="audio-files" style="display: none;">
    <audio id="click-sound">
        <source src="jbox/audio/bling2.wav" type="audio/wav" />
    </audio>
  </div>
  <!-- NAVIGATION BAR -->
  <div class="nav_dropdown">
    <p onclick="location='index'" style="background-color: orange">Home</p>
    <p onclick="location='chat'">Chat</p>
    <p onclick="location='drive'">Drive</p>
    <p onclick="location='cal'">Calendar</p>
    <p onclick="location='networks'">Networks</p>
  </div>
  <div class="navigation_bar">
      <ul id="navbar_list">
        <li class="navbar_item navbar_title navbar_title_index">
            MorTeam
        </li>
        <li class="navbar_item searchbox_list_item">
            <input type="text" placeholder="search" class="searchbox"></input>
            <div class="search_drop">
              <ul class="search_drop_items">
                <!-- <li>
                  under<br/>
                  construction
                </li>
                <li>
                  under<br/>
                  construction
                </li>
                <li>
                  under<br/>
                  construction
                </li>
                <li>
                  under<br/>
                  construction
                </li> -->
              </ul>
            </div>
        </li>
        <li class="navbar_item glyph_link chat_btn menu_btn" onclick="location='chat'">
            <span class="glyphicon glyphicon-comment"></span>
        </li>
        <li class="navbar_item glyph_link drive_btn menu_btn" onclick="location='drive'">
            <span class="glyphicon glyphicon-hdd"></span>
        </li>
        <li class="navbar_item glyph_link cal_btn menu_btn" onclick="location='cal'">
            <span class="glyphicon glyphicon-calendar"></span>
        </li>
        <li class="navbar_item glyph_link networks_btn menu_btn" onclick="location='networks'">
            <span class="glyphicon glyphicon-globe"></span>
        </li>
        <div class="navbar_item right_links">
          <li class="navbar_item glyph_link menu">
              <span class="glyphicon glyphicon-menu-hamburger"></span>
          </li>
          <li class="navbar_item glyph_link" id="notif_button">
              <span class="glyphicon glyphicon-inbox"></span>
              <span class="unseen_count bold">3</span>
          </li>
          <img class="profile_id" id="small_prof_pic" src="./images/user.jpg"></img>
          <span class="profile_name" id="name_link"></span>
        </div>
      </ul>
  </div>
  <!-- <div class="triangle_thing_notif hidden"></div>
  <div class="triangle_thing_prof hidden"></div> -->
  <div id="notif_drop" class="hidden">
      <ul>
          <li class="notif_list_item">hey</li>
          <li class="notif_list_item">hi</li>
          <li class="notif_list_item">ho</li>
      </ul>
  </div>
  <div id="prof_drop" class="hidden">
      <ul>
          <li class="notif_list_item" id="view_prof_button">View Profile and Settings</li>
          <li class="notif_list_item" id="logout_button">Log Out</li>
      </ul>
  </div>
  <div class="hidden" id="darken"></div>
  <!-- END OF NAVIGATION BAR -->
  <!-- BODY -->
  <div class="announcements_container" style="margin-top: 60px;">

      <div class="announcements_left">
        <p onclick="location='profile'">View Profile</p>
        <p id="logout_button">Log Out</p>
        <p id="team_button">MorTorq</p>
        <hr>
        <div id="your_subdivisions">
            <h5 style="margin-bottom: 15px;">Your Subdivisions</h5>
        </div>
        <hr>
        <div id="public_subdivisions">
            <h5 style="margin-bottom: 15px;">Public Subdivisions</h5>
        </div>
        <hr>
        <div id="invited_subdivisions">
            <h5 style="margin-bottom: 15px;">Subdivision Invites</h5>
        </div>
        <hr>
        <p class="new_subdivision"><span class="glyphicon glyphicon-plus"></span> Make a Subdivision</p>
        <hr>
        <p id="aboutus_link">About Us</p>
        <span>Â© 2015 MorTeam</span>
      </div>
      <div class="announcements_center">
        <div class="post_announcement cf">
            <textarea class="announcement_textarea" id="main_textarea" placeholder="Make an announcement..."></textarea>
            <input type="button" class="announcement_post_button" value="Post"></input>
            <div class=" announcement_audience_button btn-group">
                <button class="button dropdown-toggle" data-toggle="dropdown"><span class="audience_selection">Everyone</span>
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu audience_drop">
                    <li class="audience_item selected first_audience">Everyone</li>
                    <li class="audience_item">Build</li>
                    <li class="audience_item">Programming</li>
                    <li class="audience_item">Business</li>
                    <li class="audience_item custom_audience"><span class="glyphicon glyphicon-cog"></span>&nbsp;Custom</li>
                </ul>
            </div>
        </div>
        <div class="announcements_list">
            <!-- <div class="announcement" data-postNum="1">
            <div class="announcement_top">
              <img id="medium_prof_pic" src="./images/user.jpg"></img>
              <span class="announcement_poster">Farbod Rafezy</span>
            </div>
            <span class="glyphicon glyphicon-remove delete_icon"></span><br>
            the words go here
          </div> -->
        </div>
      </div>
      <div class="announcements_right">
        <div class="ad" style="margin-top: 0px; position: fixed;"></div>
      </div>

  </div>


  <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="jbox/jBox.min.js"></script>
  <script type="text/javascript" src="js/socket.io.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/2.2.1/isotope.pkgd.min.js"></script>
  <script type="text/javascript" src="js/velocity.min.js"></script>
  <script type="text/javascript" src="js/autosize.js"></script>
  <script type="text/javascript" src="js/main.js"></script>
  <script type="text/javascript">
      autosize(document.querySelectorAll('textarea'));
  </script>

  <script>
  function newSubdivisionModal(title, instructions){
    var new_modal = new jBox('Modal', {
      width: 350,
      height: 373,
      title: title
    });
    $.post("/f/getUsersInTeam", function(responseText){
      var span = document.createElement("span");
      var subdivision_name = '<input type="text" class="name_input" id="subdivision_name" placeholder="Subdivision Name">';
      var public_option = '<p class="subdivision_type public selected">Public</p>';
      var private_option = '<p class="subdivision_type private">Private</p>';
      var help = '<span class="glyphicon glyphicon-question-sign subdivision_help" title="A public subdivision can be seen and<br/> joined by anyone in the team, but joining<br/> a private subdivision requires an invitation."></span>';
      var user_search = '<input type="text" placeholder="Search Names..." class="members_search" id="subdivision_members_search">';
      var potential_members = document.createElement("div");
      $(potential_members).attr("id", "potential_subdivision_members");
      $(potential_members).addClass("potential_members");
      var create_btn = '<input type="button" id="make_subdivision_btn" class="button done_button" value="Make Subdivision">'
      var users = JSON.parse(responseText);
      for(var i = 0; i < users.length; i++){
        var user = document.createElement("p");
        $(user).addClass("potential_member");
        $(user).attr("data-userid", users[i].id);
        $(user).html(users[i].firstname + " " + users[i].lastname);
        $(potential_members).append(user);
      }
      $(span).append($(subdivision_name));
      $(span).append("<br/>");
      $(span).append($(public_option));
      $(span).append($(private_option));
      $(span).append($(help));
      $(span).append("<br/>");
      $(span).append(instructions);
      $(span).append("<br/>");
      $(span).append($(user_search));
      $(span).append("<br/>");
      $(span).append($(potential_members));
      $(span).append("<br/>");
      $(span).append($(create_btn));
      new_modal.setContent( $(span) );
      $('.subdivision_help').jBox('Tooltip', {
          delayOpen: 0,
          delayClose: 300,
          theme: "TooltipDark",
          position: {
              y: 'bottom'
          }
      });
      new_modal.open();
    })
    return new_modal;
  }
  $(document).ready(function(){
    $.post("/f/getAllSubdivisionsForUserInTeam", function(responseText){
      var subdivisions = JSON.parse(responseText);
      if(subdivisions.length != 0){
        for (var i = 0; i < subdivisions.length; i++){
          var p = document.createElement("p");
          $(p).addClass("subdivision-link");
          $(p).attr("data-subdivisionid", subdivisions[i].id);
          var glyphSpan = "<span class='glyphicon glyphicon-screenshot'></span>"
          var nameSpan = document.createElement("span");
          $(nameSpan).html(" " + subdivisions[i].name);
          $(p).append(glyphSpan);
          $(p).append(nameSpan);
          $("#your_subdivisions").append( $(p) );
        }
      }else{
        $("#your_subdivisions").append( "none" );
      }
    });
    $.post("/f/getPublicSubdivisions", function(responseText){
      var subdivisions = JSON.parse(responseText);
      if(subdivisions.length != 0){
        for(var i = 0 ; i < subdivisions.length; i++){
          var p = document.createElement("p");
          $(p).addClass("subdivision-link");
          $(p).attr("data-subdivisionid", subdivisions[i].id);
          var glyphSpan = "<span class='glyphicon glyphicon-screenshot'></span>"
          var nameSpan = document.createElement("span");
          $(nameSpan).html(" " + subdivisions[i].name);
          $(p).append(glyphSpan);
          $(p).append(nameSpan);
          $("#public_subdivisions").append( $(p) );

        }
      }else{
        $("#public_subdivisions").append( "none" );
      }
    });
    $.post("/f/loadSubdivisionInvitations", function(responseText){
      var invites = JSON.parse(responseText);
      if(invites.length != 0){
        for (var i = 0; i < invites.length; i++){
          var p = document.createElement("p");
          $(p).addClass("subdivision-invite");
          $(p).attr("data-subdivisionid", invites[i].id);
          var glyphSpan = "<span class='glyphicon glyphicon-screenshot'></span>"
          var nameSpan = document.createElement("span");
          $(nameSpan).html(" " + invites[i].name);
          $(nameSpan).addClass("nameSpan");
          $(p).append(glyphSpan);
          $(p).append(nameSpan);
          $("#invited_subdivisions").append( $(p) );
        }
      }else{
        $("#invited_subdivisions").append( "none" );
      }
    });

    $(document).on("click", ".accept-invite", function(){
      var subdivision_id = $(this).parent().attr("data-subdivisionid");
      var invite = $(this).parent();
      $.post("/f/acceptSubdivisionInvitation", {subdivision_id: subdivision_id}, function(responseText){
        console.log(responseText);
        if(responseText == "success"){
          invite.remove();
        }
      })
    });
    var subdivision_invite_modal = new jBox('Modal', {
      width: 'auto',
      height: 'auto',
      title: 'Subdivison Invitation',
    });

    $(document).on("click", ".subdivision-link", function(){
      location = "/s/" + $(this).attr("data-subdivisionid");
    });
    $(document).on("click", ".subdivision-invite", function(){
      subdivision_invite_modal.setContent('<span><span class="inviter"></span> You have been invited to the subdivison: <span class="invited_scope_name">'+$(this).find(".nameSpan").html()+'</span></span><br/><div style="text-align: center"><input type="button" class="button invite_btn accept_invite_btn" data-subdivisionid="'+$(this).attr("data-subdivisionid")+'" value="Accept"></input><input type="button" class="button invite_btn ignore_invite_btn" data-subdivisionid="'+$(this).attr("data-subdivisionid")+'" value="Hide"></input></div>')
      subdivision_invite_modal.open();
    });
    $(document).on("click", ".accept_invite_btn", function(){
      var $this = $(this);
      $.post("/f/acceptSubdivisionInvitation", {subdivision_id: $(this).attr("data-subdivisionid")}, function(responseText){
        if(responseText=="success"){
          subdivision_invite_modal.close();
          var acceptedSubdivision = $("#invited_subdivisions p[data-subdivisionid='"+ $this.attr("data-subdivisionid") +"']").clone();
          acceptedSubdivision.removeClass("subdivision-invite");
          acceptedSubdivision.addClass("subdivision-link");
          if( $("#your_subdivisions")[0].innerHTML.indexOf("none") > -1 ){
            $("#your_subdivisions").empty();
            $("#your_subdivisions").append('<h5 style="margin-bottom: 15px;">Your Subdivisions</h5>');
          }
          $("#your_subdivisions").append(acceptedSubdivision);
          $("#invited_subdivisions p[data-subdivisionid='"+ $this.attr("data-subdivisionid") +"']").remove();
        }else{
          alert("fail");
        }
      });
    });
    $(document).on("click", ".ignore_invite_btn", function(){
      var $this = $(this);
      $.post("/f/ignoreSubdivisionInvite", {subdivision_id: $(this).attr("data-subdivisionid")}, function(responseText){
        if(responseText=="success"){
          subdivision_invite_modal.close();
          $("#invited_subdivisions p[data-subdivisionid='"+ $this.attr("data-subdivisionid") +"']").remove();
        }else{
          alert("fail");
        }
      });
    });


    //general modal stuff
    $(document).on("click", ".potential_member", function(){
      if($(this).hasClass("clicked")){
        $(this).removeClass("clicked");
      }else{
        $(this).addClass("clicked");
      }
    });
    $(document).on("keyup", '.members_search', function() {
      var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
      $('.potential_members p').show().filter(function() {
          var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
          console.log(!~text.indexOf(val));
          return !~text.indexOf(val);
      }).hide();
    });

    //new subdivison modal
    $(document).on("click", ".new_subdivision", function(){
      new_subdivision_modal = newSubdivisionModal("New Subdivison", "Please select some initial members");
    })
    $(document).on("click", ".subdivision_type", function(){
      $(".subdivision_type").removeClass("selected");
      $(this).addClass("selected");
    });
    $(document).on("click", '#make_subdivision_btn', function() {
      var type;
      if ($(".public").hasClass("selected")){
        type = "public";
      }else{
        type = "private";
      }
      var p_selected_users = $("p.clicked");
      var selectedUsers = [];
      for (var i = 0; i < p_selected_users.length; i++) {
        selectedUsers.push($(p_selected_users[i]).attr("data-userid"));
      }
      $.post("/f/createSubdivision", {name: $("#subdivision_name").val(), type: type}, function(responseText){
        if(responseText != "fail"){
          for(var i=0; i<selectedUsers.length; i++){
            $.post("/f/inviteToSubdivision", {user_id: selectedUsers[i], subdivision_id: responseText}, function(responseText){
              if(responseText == "success"){
                //
              }else{
                alert("fail");
              }
            });
          }
          new_subdivision_modal.close();
          location="/";
        }else{
          alert("failed to create");
        }
      });
    });


  });
  </script>
</body>

</html>
